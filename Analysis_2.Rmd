---
title: "Analysis_First_Chapter2"
author: "Laura Blanco"
date: "23/5/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

# 1. Uploading Libraries 

```{r}
library(tidyr)
library(tidyverse)
library(ggplot2)
library(survival)
library(survminer)
library(ranger)
library(ggplot2)
library(ggpubr)
library(ggsci)
library(readxl)
library(showtext)
library(lubridate)
setwd("C:\\Users\\lblan\\OneDrive\\Escritorio\\CEAB\\2022\\First_chapter")
data_analysis <- 
  read_excel("C:/Users/lblan/OneDrive/Escritorio/CEAB/2022/First_chapter/data_analysis_cens.xlsx", 
    col_types = c("numeric", "date", "date", 
        "numeric", "numeric", "numeric", "numeric"))

#Now, data of weather (RH and Temperature) in both locations in the field (HOBO's data)
jardin_clima <- 
  read_excel("C:/Users/lblan/OneDrive/Escritorio/CEAB/2022/Jardin_clima_total.xlsx", 
    col_types = c("date", "numeric", "numeric"))

palafolls_clima <- 
  read_excel("C:/Users/lblan/OneDrive/Escritorio/CEAB/2022/Palafolls_clima_total.xlsx", 
    col_types = c("date", "numeric", "numeric"))

#URBAN DATAFRAME OF WEATHER
temperaturemeanpal<- palafolls_clima%>% 
  #v#calculating means of temperature and rhper day (HOBO makes 3 measures per day)
  group_by(DATE)%>%
  summarise(meantemperature=mean(TEMPERATURE),meanrh = mean(RH) )

temperatureminpal<- palafolls_clima%>% 
  #v#calculating mins of temperature and rhper day (HOBO makes 3 measures per day)
  group_by(DATE)%>%
  summarise(mintemperature=min(TEMPERATURE),minrh = min(RH) )

temperaturemaxpal<- palafolls_clima%>% 
  #v#calculating max of temperature and rhper day (HOBO makes 3 measures per day)
  group_by(DATE)%>%
  summarise(maxtemperature=max(TEMPERATURE),maxrh = max(RH) )
palafolls_clima<- merge(temperaturemaxpal, temperaturemeanpal, by = "DATE")
palafolls_clima_total<- merge(palafolls_clima, temperatureminpal, by = "DATE")
remove(palafolls_clima)
remove(temperaturemaxpal)
remove(temperatureminpal)
remove(temperaturemeanpal)

#SEMI-URBAN DATAFRAME OF WEATHER
temperaturemeanjar<- jardin_clima%>% #calculating means of temperature and rh per day
  group_by(DATE)%>%
  summarise(meantemperature=mean(TEMPERATURE),meanrh = mean(RH))

temperatureminjar<- jardin_clima%>% #calculating min of temperature and rh per day
  group_by(DATE)%>%
  summarise(mintemperature=min(TEMPERATURE),minrh = min(RH))

temperaturemaxjar<- jardin_clima%>% #calculating max of temperature and rh per day
  group_by(DATE)%>%
  summarise(maxtemperature=max(TEMPERATURE),maxrh = max(RH))
jardin_clima<- merge(temperaturemaxjar, temperaturemeanjar, by = "DATE")
jardin_clima_total<- merge(jardin_clima, temperatureminjar, by = "DATE")
remove(jardin_clima)
remove(temperaturemaxjar)
remove(temperaturemeanjar)
remove(temperatureminjar)

jardin_clima_total$location <- "1" 
#creating new columns according to the locations
jardin_clima_total$location<- as.numeric(jardin_clima_total$location)
palafolls_clima_total$location<- "2"
palafolls_clima_total$location<- as.numeric(palafolls_clima_total$location)
#renaming column DATE to match with start_date column from our data_analysis dataframe
jardin_clima_total <- jardin_clima_total %>% 
  rename(start_date = DATE)
palafolls_clima_total <- palafolls_clima_total %>% 
  rename(start_date = DATE)

datos_semi <- inner_join(data_analysis, jardin_clima_total, 
                         by = c("start_date", "location"), all= TRUE) 
#Combining temperature of each location with the data
datos_urban <- inner_join(data_analysis, palafolls_clima_total, 
                          by = c("start_date", "location"), all= TRUE)
datos_lab<- subset(data_analysis, location=="3")
datos_lab$meantemperature <- NA
datos_lab$meanrh <- NA
datos_lab$mintemperature <- NA
datos_lab$minrh <- NA
datos_lab$maxtemperature <- NA
datos_lab$maxrh <- NA
datos_field_lab <- rbind(datos_semi,datos_urban, datos_lab) 
#merging all to have a dataframe completed (data survival + weather)
datos_field<- rbind(datos_semi, datos_urban)
clima_field <- rbind(jardin_clima_total, palafolls_clima_total)
``` 
# 2. Creating weather variables and duplicating rows per mosquito

```{r}
df <- read_excel("datos_field.xlsx", 
                 col_types = c("numeric", 
                                   "date", "date", "numeric", "numeric", 
                                   "numeric", "numeric", "numeric", "numeric", 
                                  "numeric", "numeric", "numeric", "numeric"))
clima <- read_excel("clima_field.xlsx", 
                    col_types = c("date", 
                                     "numeric", "numeric", "numeric", "numeric", 
                                      "numeric", "numeric", "numeric"))

new_df <- df[0, ] 
# this also works, mantaining object structure (data.frame) and column names

id <- seq_len(nrow(df)) # since there are duplicated ID, we iterate by row

df$start_date <- as.Date(df$start_date, format = '%Y-%m-%d')

df$start_date <- as.Date(df$start_date, format = '%Y-%m-%d')
clima$start_date <- as.character(as.Date(clima$start_date, format = '%Y-%m-%d'))

new_df <- do.call('rbind', lapply(seq_len(nrow(df)), function(id){
  tmp <- do.call('rbind', replicate(df$total_lived[id],
                                    df[id, ], simplify = FALSE))
  tmp$start_date <- format(seq(tmp$start_date[1], by = 'day',
                               length.out = nrow(tmp)), '%Y-%m-%d')
  tmp
}))

vars <- c('maxtemperature', 'meantemperature', 
          'mintemperature', 'maxrh', 'minrh', 'meanrh')
for(d in unique(clima$start_date)){
  new_df[new_df$start_date == d & new_df$location == 1, vars] <-
    clima[clima$start_date == d & clima$location == 1, vars]
  new_df[new_df$start_date == d & new_df$location == 2, vars] <-
    clima[clima$start_date == d & clima$location == 2, vars]
}
```

### Adding photoperiod

```{r}
#we add photoperiod
library(meteor)
photoperiod <- photoperiod(152:334,  41.6833)
photoperiod <- as.data.frame(photoperiod)
values = seq(from = as.Date("2021-06-01"), to = as.Date("2021-11-30"), 
             by = 'day')
photoperiod$dates <- values
photoperiod$dates <- as.character(as.Date(photoperiod$dates, 
                                          format = '%Y-%m-%d'))
new_df$start_date <- as.character(as.Date(new_df$start_date, 
                                          format = '%Y-%m-%d'))

str(photoperiod)
new_df[ , 'photoperiod'] <- 0 # new column called photoperiod
vars2 <- c('photoperiod')
for(d in unique(photoperiod$dates)){
  new_df[new_df$start_date == d,vars2] <-
    photoperiod[photoperiod$dates == d, vars2]
}

new_df$`hl/bg` <- factor(new_df$`hl/bg`, 
                         levels = c("1", "2"), 
                         labels = c("HL", "BG"))
new_df$location <- factor(new_df$location, 
                          levels = c("1", "2"), 
                          labels = c("Semi_Urban", "Urban"))

```
## Other weather parameters: GDD and MWI

### Growing degree days

```{r}
library(scales)
library(pollen)
new_df_gdd <- new_df %>% 
  mutate(gdd = gdd(tmax = maxtemperature, tmin = mintemperature, tbase = 10,
                   tbase_max = 30)) %>% 
  mutate(daily_acc_gdd = c(NA, diff(gdd)))

ddfield <- datos_field %>% 
  mutate(gdd = gdd(tmax = maxtemperature, tmin = mintemperature, tbase = 10, 
                   tbase_max = 30)) %>% 
  mutate(daily_acc_gdd = c(NA, diff(gdd)))

gdd <-ggplot(aes(x =start_date, y= daily_acc_gdd), data = ddfield) + geom_line()
gdd

```

### MWI

```{r}
mwi = function(Hum, Temp) {
 FH = case_when(Hum < 40~0, Hum >95~0, (Hum >=40 & Hum <= 95)~
                  ((Hum/55)-(40/55)) )
  FT = case_when(Temp<=15~0, Temp>30~0, (Temp>15 & Temp <=20)~ 
                   (.2*Temp)-3, (Temp>20 & Temp<=25)~1, (Temp>25 & Temp <= 30)~
                   (-.2*6)+6)
  return(FH*FT)
}

new_df_gdd <- new_df_gdd %>% 
  mutate(Hum = meanrh, Temp = meantemperature)

new_df_gdd = new_df_gdd %>% mutate(
  FH = case_when(Hum < 40~0, Hum >95~0, (Hum >=40 & Hum <= 95)~
                   ((Hum/55)-(40/55)) ),
  FT = case_when(Temp<=15~0, Temp>30~0, (Temp>15 & Temp <=20)~ (.2*Temp)-3, 
                 (Temp>20 & Temp<=25)~1, (Temp>25 & Temp <= 30)~ (-.2*Temp)+6),
  mwi = FH*FT)

ddfield <- ddfield %>% 
  mutate(Hum = meanrh, Temp = meantemperature)

ddfield = ddfield %>% mutate(
  FH = case_when(Hum < 40~0, Hum >95~0, (Hum >=40 & Hum <= 95)~
                   ((Hum/55)-(40/55)) ),
  FT = case_when(Temp<=15~0, Temp>30~0, (Temp>15 & Temp <=20)~ (.2*Temp)-3, 
                 (Temp>20 & Temp<=25)~1, (Temp>25 & Temp <= 30)~ (-.2*Temp)+6),
  mwi = FH*FT)



mwiplot <-ggplot(aes(x =start_date, y= mwi), data = ddfield) + geom_line()
mwiplot


```

# 3.Cox-Regression models

1. No random effects
2. Random effects; level 1 (method) + level 2 (location);
    - Separated: (1|method) + (1|location)
    - Together: (1|location/method), to check the effect of the method of capture within location
    
## Temperature

###  Models with minimum temperatures

```{r}
new_df_gdd <- new_df_gdd  %>% 
  rename(method = 'hl/bg')
library(coxme)
```

```{r}
# No random effect
cox_mint<- coxph(Surv(total_lived, censored) ~ mintemperature, data= new_df_gdd)

summary(cox_mint)
```

```{r}
#Random effect - separated
coxme_mint_s<- coxme(Surv(total_lived, censored) ~ mintemperature + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_mint_s)
```

```{r}
#Random effect - together
coxme_mint_t<- coxme(Surv(total_lived, censored) ~ mintemperature + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_mint_t)
```

### Models with mean temperatures

```{r}
# No random effect
cox_meant<- coxph(Surv(total_lived, censored) ~ meantemperature, 
                  data= new_df_gdd)

summary(cox_meant)
```

```{r}
#Random effect - separated
coxme_meant_s<- coxme(Surv(total_lived, censored) ~ meantemperature + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_meant_s)
```

```{r}
#Random effect - together
coxme_meant_t<- coxme(Surv(total_lived, censored) ~ meantemperature + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_meant_t)
```

### Models with maximum temperatures

```{r}
# No random effect
cox_maxt<- coxph(Surv(total_lived, censored) ~ maxtemperature, 
                  data= new_df_gdd)

summary(cox_maxt)
```

```{r}
#Random effect - separated
coxme_maxt_s<- coxme(Surv(total_lived, censored) ~ maxtemperature + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_maxt_s)
```

```{r}
#Random effect - together
coxme_maxt_t<- coxme(Surv(total_lived, censored) ~ maxtemperature + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_maxt_t)
```

### MWI (Mosquito Weather Index)

```{r}
# No random effect
cox_mwi<- coxph(Surv(total_lived, censored) ~ mwi, 
                  data= new_df_gdd)

summary(cox_mwi)
```

```{r}
#Random effect - separated
coxme_mwi_s<- coxme(Surv(total_lived, censored) ~ mwi + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_mwi_s)
```

```{r}
#Random effect - together
coxme_mwi_t<- coxme(Surv(total_lived, censored) ~ mwi + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_mwi_t)
```

### GDD (Growing Degree Days)

```{r}
# No random effect
cox_gdd<- coxph(Surv(total_lived, censored) ~ daily_acc_gdd, 
                  data= new_df_gdd)

summary(cox_gdd)
```

```{r}
#Random effect - separated
coxme_gdd_s<- coxme(Surv(total_lived, censored) ~ daily_acc_gdd + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_gdd_s)
```

```{r}
#Random effect - together
coxme_gdd_t<- coxme(Surv(total_lived, censored) ~ daily_acc_gdd + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_gdd_t)
```

### Checking all temperatures together

```{r}
# No random effect
cox_temps<- coxph(Surv(total_lived, censored) ~ mintemperature + meantemperature
                  + maxtemperature + mwi + daily_acc_gdd, 
                  data= new_df_gdd)

summary(cox_temps)
```

```{r}
#Random effect - separated
coxme_temps_s<- coxme(Surv(total_lived, censored) ~ mintemperature + meantemperature
                  + maxtemperature + mwi + daily_acc_gdd + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_temps_s)
```

```{r}
#Random effect - together
coxme_temps_t<- coxme(Surv(total_lived, censored) ~ mintemperature +
                        meantemperature
                  + maxtemperature + mwi + daily_acc_gdd +
                   (1|location/method), data= new_df_gdd)

summary(coxme_temps_t)
```

### Checking collinearity in the 3 cases

```{r}
#No random effects
rms::vif(cox_temps)
#daily_acc_gdd has a lot of collinearity so we should remove it and do it again
cox_temps2 <- coxph(Surv(total_lived, censored) ~ mintemperature + meantemperature
                  + maxtemperature + mwi, 
                  data= new_df_gdd)

summary(cox_temps2)
rms::vif(cox_temps2)
#mean temperature is the next variable with higher VIF, we remove it and repeat
cox_temps3 <- coxph(Surv(total_lived, censored) ~ mintemperature 
                  + maxtemperature + mwi, 
                  data= new_df_gdd)
summary(cox_temps3)
rms::vif(cox_temps3)
```
```{r}
#Random effects - Separated
rms::vif(coxme_temps_s)
#daily_acc_gdd has a lot of collinearity so we should remove it and do it again
coxme_temps_s2<- coxme(Surv(total_lived, censored) ~ mintemperature + meantemperature
                  + maxtemperature + mwi  + 
                   (1|location) + (1|method), data= new_df_gdd)

summary(coxme_temps_s2)
rms::vif(coxme_temps_s2)
#mean temperature is the next variable with higher VIF, we remove it and repeat
coxme_temps_s3<- coxme(Surv(total_lived, censored) ~ mintemperature 
                  + maxtemperature + mwi  + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_temps_s3)
rms::vif(coxme_temps_s3)
```
```{r}
#Random effects - Together
rms::vif(coxme_temps_t)
#daily_acc_gdd has a lot of collinearity so we should remove it and do it again
coxme_temps_t2<- coxme(Surv(total_lived, censored) ~ mintemperature +
                        meantemperature
                  + maxtemperature + mwi  +
                   (1|location/method), data= new_df_gdd)


summary(coxme_temps_t2)
rms::vif(coxme_temps_t2)
#mean temperature is the next variable with higher VIF, we remove it and repeat
coxme_temps_t3<- coxme(Surv(total_lived, censored) ~ mintemperature
                  + maxtemperature + mwi  +
                   (1|location/method), data= new_df_gdd)


summary(coxme_temps_t3)
rms::vif(coxme_temps_t3)
```
## Relative Humidity

### Minimum relative humidity

```{r}
# No random effect
cox_minrh<- coxph(Surv(total_lived, censored) ~ minrh, 
                  data= new_df_gdd)

summary(cox_minrh)
```

```{r}
#Random effect - separated
coxme_minrh_s<- coxme(Surv(total_lived, censored) ~ minrh + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_minrh_s)
```

```{r}
#Random effect - together
coxme_minrh_t<- coxme(Surv(total_lived, censored) ~ minrh + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_minrh_t)
```

### Mean relative humidity

```{r}
# No random effect
cox_meanrh<- coxph(Surv(total_lived, censored) ~ meanrh, 
                  data= new_df_gdd)

summary(cox_meanrh)
```

```{r}
#Random effect - separated
coxme_meanrh_s<- coxme(Surv(total_lived, censored) ~ meanrh + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_meanrh_s)
```

```{r}
#Random effect - together
coxme_meanrh_t<- coxme(Surv(total_lived, censored) ~ meanrh + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_meanrh_t)
```

### Maximum relative humidity

```{r}
# No random effect
cox_maxrh<- coxph(Surv(total_lived, censored) ~ maxrh, 
                  data= new_df_gdd)

summary(cox_maxrh)
```

```{r}
#Random effect - separated
coxme_maxrh_s<- coxme(Surv(total_lived, censored) ~ maxrh + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_maxrh_s)
```

```{r}
#Random effect - together
coxme_maxrh_t<- coxme(Surv(total_lived, censored) ~ maxrh + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_maxrh_t)
```

### All RH together + Check collinearity

```{r}
#No random effects
cox_rhs <- coxph(Surv(total_lived, censored) ~ minrh + meanrh
                  + maxrh + mwi, 
                  data= new_df_gdd)
rms::vif(cox_rhs)
#meanrh has a lot of collinearity so we should remove it and do it again
cox_rhs2 <- coxph(Surv(total_lived, censored) ~ minrh + maxrh
                  + mwi, 
                  data= new_df_gdd)

summary(cox_rhs2)
rms::vif(cox_rhs2)

#Shall we eliminate a variable here?
stats::step(cox_rhs2)
cox_rhs3 <- coxph(Surv(total_lived, censored) ~ minrh
                  + mwi, 
                  data= new_df_gdd)

summary(cox_rhs3)

```

```{r}
#Random effects - Separated
coxme_rh_s<- coxme(Surv(total_lived, censored) ~ minrh + meanrh
                  + maxrh + mwi  + 
                   (1|location) + (1|method), data= new_df_gdd)

summary(coxme_rh_s)
rms::vif(coxme_rh_s)
#meanrh has a lot of collinearity so we should remove it and do it again
coxme_rh_s2<- coxme(Surv(total_lived, censored) ~ minrh + maxrh + mwi  + 
                   (1|location) + (1|method), data= new_df_gdd)

summary(coxme_rh_s2)
rms::vif(coxme_rh_s2)

```

```{r}
#Random effects - Together
coxme_rh_t<- coxme(Surv(total_lived, censored) ~ minrh + meanrh
                  + maxrh + mwi  + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_rh_t)
rms::vif(coxme_rh_t)
#meanrh has a lot of collinearity so we should remove it and do it again
coxme_rh_t2<- coxme(Surv(total_lived, censored) ~ minrh + maxrh + mwi  + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_rh_t2)
rms::vif(coxme_rh_t2)

```

## Photoperiod

```{r}
# No random effect
cox_pho<- coxph(Surv(total_lived, censored) ~ photoperiod, 
                  data= new_df_gdd)

summary(cox_pho)
```

```{r}
#Random effect - separated
coxme_pho_s<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                   (1|location) + (1|method), data= new_df_gdd)
summary(coxme_pho_s)
```

```{r}
#Random effect - together
coxme_pho_t<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                   (1|location/method), data= new_df_gdd)

summary(coxme_pho_t)
```


## Complete models, adding all variables

```{r}
#No random effect

cox_allv<- coxph(Surv(total_lived, censored) ~ photoperiod + minrh + meanrh +
                  maxrh + mintemperature + meantemperature + maxtemperature + 
                  mwi + daily_acc_gdd +location + method, data= new_df_gdd)

summary(cox_allv)
rms::vif(cox_allv) #meantemperature with high vif

cox_allv2<- coxph(Surv(total_lived, censored) ~ photoperiod + minrh + meanrh +
                  maxrh + mintemperature  + maxtemperature + 
                  mwi + daily_acc_gdd+location + method, data= new_df_gdd)

summary(cox_allv2)
rms::vif(cox_allv2) #meanrh with high vif

cox_allv3<- coxph(Surv(total_lived, censored) ~ photoperiod + minrh  +
                  maxrh + mintemperature  + maxtemperature + 
                  mwi+  daily_acc_gdd+location + method, data= new_df_gdd)
summary(cox_allv3)
rms::vif(cox_allv3) #maxtemperature with high vif


new_df_gdd <- na.omit(new_df_gdd)
cox_allv4<- coxph(Surv(total_lived, censored) ~ photoperiod + minrh  +
                  maxrh   + mintemperature + 
                  mwi +  daily_acc_gdd+ location + method, data= new_df_gdd)
summary(cox_allv4)
rms::vif(cox_allv4)
stats::step(cox_allv4)
cox_allv5<- coxph(Surv(total_lived, censored) ~ photoperiod +  mintemperature + 
                  mwi+ location + method, data= new_df_gdd)
```

```{r}
#Random effect - separated
coxme_allv<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh + meanrh +
                      maxrh + mintemperature + meantemperature + maxtemperature +
                      mwi + (1|location) + (1|method), data= new_df_gdd)
summary(coxme_allv)

rms::vif(coxme_allv) #meantemperature with high vif

coxme_allv2<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh + meanrh +
                      maxrh + mintemperature  + maxtemperature +
                      mwi + (1|location) + (1|method), data= new_df_gdd)
summary(coxme_allv2)
rms::vif(coxme_allv2) #meanrh with high vif

coxme_allv3<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + mintemperature  + maxtemperature +
                      mwi + (1|location) + (1|method), data= new_df_gdd)
summary(coxme_allv3)
rms::vif(coxme_allv3) #maxtemperature with high vif

coxme_allv4<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh +  mwi + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

coxme_allv5<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + mintemperature +  (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

coxme_allv6<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + mintemperature +
                      mwi + (1|location) + (1|method), data= new_df_gdd, 
                    refine.n = 500)

coxme_allv7<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + daily_acc_gdd +
                      mintemperature + (1|location) + (1|method), data= new_df_gdd, 
                    refine.n = 500)

coxme_allv8<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + daily_acc_gdd + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

coxme_allv4$refine
round(quantile(ranef(coxme_allv4)[[1]], 0:8/8), 2)
rms::vif(coxme_allv4)
#ranef(coxme_allv4)
#VarCorr(coxme_allv4)
coxme_allv4$loglik
print(coxme_allv4)
print(coxme_allv5)
exp(confint(coxme_allv5))
print(coxme_allv6)
print(coxme_allv7)
print(coxme_allv8)
rms::vif(coxme_allv7)

```

```{r}
#Random effect - together
coxme_allv_t<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh + meanrh +
                     maxrh + mintemperature + meantemperature + maxtemperature + 
                     mwi + (1|location/method), data= new_df_gdd)

summary(coxme_allv_t)
rms::vif(coxme_allv_t) #meantemperature with high vif

coxme_allv_t2<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh + meanrh +
                     maxrh + mintemperature + maxtemperature + 
                     mwi + (1|location/method), data= new_df_gdd)

summary(coxme_allv_t2)
rms::vif(coxme_allv_t2) #meanrh with highest vif

coxme_allv_t3<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     maxrh + mintemperature + maxtemperature + 
                     mwi + (1|location/method), data= new_df_gdd)

summary(coxme_allv_t3)
rms::vif(coxme_allv_t3) #maxtemperature with highest vif

coxme_allv_t4<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     maxrh + mwi +  (1|location/method), data= new_df_gdd, refine.n = 500)

coxme_allv_t5<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     maxrh + mintemperature   +
                    (1|location/method), data= new_df_gdd, refine.n = 500)

coxme_allv_t6<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     maxrh + mwi + mintemperature + 
                    (1|location/method), data= new_df_gdd, refine.n = 500)

coxme_allv_t7<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     maxrh + daily_acc_gdd + mintemperature + 
                    (1|location/method), data= new_df_gdd, refine.n = 500)
coxme_allv_t8<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     maxrh + daily_acc_gdd + 
                    (1|location/method), data= new_df_gdd, refine.n = 500)

rms::vif(coxme_allv_t5)
print(coxme_allv_t4)
print(coxme_allv_t5)
print(coxme_allv_t6)
print(coxme_allv_t7)
print(coxme_allv_t8)

print(coxme_allv_t5)
exp(confint(coxme_allv_t5))

```


# We add the levels separately and related in the same model.
```{r}

coxme_t1<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     maxrh + mintemperature  + maxtemperature +
                     mwi + (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)

print(coxme_t1)
coxme_t1$refine
rms::vif(coxme_t1)
#removing maxtemperature
coxme_t2<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     maxrh + mintemperature  +
                     mwi + (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)
coxme_t3<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     maxrh   + mwi +
                    (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)
coxme_t4<- coxme(Surv(total_lived, censored) ~ photoperiod + mintemperature + mwi 
                 + minrh + maxrh +
                    (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)
coxme_t5<- coxme(Surv(total_lived, censored) ~ photoperiod + daily_acc_gdd+ minrh
                 + maxrh + 
                    (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)
coxme_t6<- coxme(Surv(total_lived, censored) ~ photoperiod + daily_acc_gdd+ 
                   mintemperature +minrh
                 + maxrh + 
                    (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)
coxme_t7<- coxme(Surv(total_lived, censored) ~ photoperiod + mintemperature+ minrh
                 + maxrh + 
                    (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)
print(coxme_t3)
print(coxme_t4)
print(coxme_t5)
print(coxme_t6)
print(coxme_t7)
exp(confint(coxme_t7))


rms::vif(coxme_t5)
rms::vif(coxme_t6)
rms::vif(coxme_t7)
anova(coxme_t5, coxme_t7)

rms::vif(coxme_t2)
print(coxme_t3)
coxme_t2$refine
rms::vif(coxme_t2)

```
```{r}
library(finalfit)
explanatory = c("photoperiod", "mintemperature", "mwi", "daily_acc_gdd", "location", "method")
dependent = "Surv(total_lived, censored)"
new_df_gdd %>%
  finalfit(dependent, explanatory) -> t1
knitr::kable(t1, align=c("l", "l", "r", "r", "r"))

```

# MODIFICATIONS IN THE MODEL WITH MINTEMPERATURE/GDD AS CHOSEN VARIABLE.

Now that we have clear the 2 temperature variables, we need to check the RH variables:
 
 - Do we need minimum and maximum RH?
 - We will put them, for each previous model (with mintemp), separately and united, and we will check what is better.
 
 **1. Model 2 - location and method as separated random effects (1|method) + (1|location)**
 
 
```{r}
coxme_allv5_minrh<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     mintemperature +  (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)
print(coxme_allv5_minrh)

coxme_allv5_maxrh<- coxme(Surv(total_lived, censored) ~ photoperiod +  maxrh +
                            mintemperature +  (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)
print(coxme_allv5_maxrh)
coxme_allv5
print(coxme_allv5)
anova(coxme_allv5,coxme_allv5_minrh, coxme_allv5_maxrh) #looking the ANOVA, the
#best is the third, including only maxrh


coxme_allv4<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh +  mwi + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)
coxme_allv4min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                        mwi + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)
coxme_allv4max<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                      maxrh +  mwi + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

anova(coxme_allv4, coxme_allv4min, coxme_allv4max)

coxme_allv6<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + mintemperature +
                      mwi + (1|location) + (1|method), data= new_df_gdd, 
                    refine.n = 500)
coxme_allv6min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                       mintemperature +
                      mwi + (1|location) + (1|method), data= new_df_gdd, 
                    refine.n = 500)
coxme_allv6max<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                      maxrh + mintemperature +
                      mwi + (1|location) + (1|method), data= new_df_gdd, 
                    refine.n = 500)

anova(coxme_allv6, coxme_allv6min, coxme_allv6max)


coxme_allv7<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + daily_acc_gdd +
                      mintemperature + (1|location) + (1|method), data= new_df_gdd, 
                    refine.n = 500)
coxme_allv7min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                       daily_acc_gdd +
                      mintemperature + (1|location) + (1|method), data= new_df_gdd, 
                    refine.n = 500)
coxme_allv7max<- coxme(Surv(total_lived, censored) ~ photoperiod  +
                      maxrh + daily_acc_gdd +
                      mintemperature + (1|location) + (1|method), data= new_df_gdd, 
                    refine.n = 500)
anova(coxme_allv7, coxme_allv7min, coxme_allv7max)


coxme_allv8<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + daily_acc_gdd + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

coxme_allv8min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      daily_acc_gdd + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

coxme_allv8max<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                      maxrh + daily_acc_gdd + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

anova(coxme_allv8, coxme_allv8min, coxme_allv8max)
#All temperatures  + maxrh
print(coxme_allv4max)
print(coxme_allv5_maxrh)
print(coxme_allv6max)
print(coxme_allv7max) #collinear
print(coxme_allv8max)
anova(coxme_allv4max,coxme_allv5_maxrh,coxme_allv6max,
      coxme_allv8max )

#All temperatures + minrh
print(coxme_allv4min)
print(coxme_allv5_minrh)
print(coxme_allv6min)
print(coxme_allv7min) #collinear
print(coxme_allv8min)
anova(coxme_allv4min,coxme_allv5_minrh,coxme_allv6min,
      coxme_allv8min )

#All temperatures + all RH
print(coxme_allv4)
print(coxme_allv5)
print(coxme_allv6)
print(coxme_allv7) #collinear
print(coxme_allv8)
anova(coxme_allv4,coxme_allv5,coxme_allv6,
      coxme_allv8 )

anova(coxme_allv5, coxme_allv5_minrh, coxme_allv5_maxrh, coxme_allv8, 
      coxme_allv8min, coxme_allv8max)
#We do ANOVA of the ones preferred in the previous ANOVA, minT and GDD (lower AIC
# and BIC).

##PREFERRED ONES: MAXRH as preferred RH, MinT and GDD as preferred temperatures

#Model 3: ~photoperiod + maxrh + mintemperature + (1 | location) + (1 | method)
#Model 6: ~photoperiod + maxrh + daily_acc_gdd + (1 | location) + (1 | method)

print(coxme_allv5_maxrh)
exp(confint(coxme_allv5_maxrh))

##AND WHAT ABOUT THE GDD?

print(coxme_allv8max)
exp(confint(coxme_allv8max))
```


 **2. Model 3 - location and method together (1|location/method)**
 
```{r}
coxme_allv_t5minrh<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                     mintemperature +  (1 | location/method), 
                    data= new_df_gdd, 
                    refine.n = 500)
print(coxme_allv_t5minrh)

coxme_allv_t5maxrh<- coxme(Surv(total_lived, censored) ~ photoperiod + maxrh  +
                     mintemperature +  (1 | location/method), 
                    data= new_df_gdd, 
                    refine.n = 500)
print(coxme_allv_t5maxrh)
print(coxme_allv_t5)
anova(coxme_allv_t5,coxme_allv_t5minrh, coxme_allv_t5maxrh) #looking the ANOVA, the
#best is the third, including only maxrh


coxme_allv_t4<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh +  mwi + (1 | location/method), 
                    data= new_df_gdd, 
                    refine.n = 500)
coxme_allv_t4min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                        mwi + (1 | location/method), 
                    data= new_df_gdd, 
                    refine.n = 500)
coxme_allv_t4max<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                      maxrh +  mwi + (1 | location/method), 
                    data= new_df_gdd, 
                    refine.n = 500)

anova(coxme_allv_t4, coxme_allv_t4min, coxme_allv_t4max)

coxme_allv_t6<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + mintemperature +
                      mwi + (1 | location/method), data= new_df_gdd, 
                    refine.n = 500)
coxme_allv_t6min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                       mintemperature +
                      mwi + (1 | location/method), data= new_df_gdd, 
                    refine.n = 500)
coxme_allv_t6max<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                      maxrh + mintemperature +
                      mwi + (1 | location/method), data= new_df_gdd, 
                    refine.n = 500)

anova(coxme_allv_t6, coxme_allv_t6min, coxme_allv_t6max)


coxme_allv_t7<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + daily_acc_gdd +
                      mintemperature + (1 | location/method), data= new_df_gdd, 
                    refine.n = 500)
coxme_allv_t7min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                       daily_acc_gdd +
                      mintemperature + (1 | location/method), data= new_df_gdd, 
                    refine.n = 500)
coxme_allv_t7max<- coxme(Surv(total_lived, censored) ~ photoperiod  +
                      maxrh + daily_acc_gdd +
                      mintemperature + (1 | location/method), data= new_df_gdd, 
                    refine.n = 500)
anova(coxme_allv_t7, coxme_allv_t7min, coxme_allv_t7max)


coxme_allv_t8<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + daily_acc_gdd + (1 | location/method), 
                    data= new_df_gdd, 
                    refine.n = 500)

coxme_allv_t8min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      daily_acc_gdd + (1 | location/method), 
                    data= new_df_gdd, 
                    refine.n = 500)

coxme_allv_t8max<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                      maxrh + daily_acc_gdd + (1 | location/method), 
                    data= new_df_gdd, 
                    refine.n = 500)

anova(coxme_allv_t8, coxme_allv_t8min, coxme_allv_t8max)
#All temperatures  + maxrh
print(coxme_allv_t4max)
print(coxme_allv_t5maxrh)
print(coxme_allv_t6max)
print(coxme_allv_t7max) #collinear
print(coxme_allv_t8max)
anova(coxme_allv_t4max,coxme_allv_t5maxrh,coxme_allv_t6max,
      coxme_allv_t8max )

#All temperatures + minrh
print(coxme_allv_t4min)
print(coxme_allv_t5minrh)
print(coxme_allv_t6min)
print(coxme_allv_t7min) #collinear
print(coxme_allv_t8min)
anova(coxme_allv_t4min,coxme_allv_t5minrh,coxme_allv_t6min,
      coxme_allv_t8min )

#All temperatures + all RH
print(coxme_allv_t4)
print(coxme_allv_t5)
print(coxme_allv_t6)
print(coxme_allv_t7) #collinear
print(coxme_allv_t8)
anova(coxme_allv_t4,coxme_allv_t5,coxme_allv_t6,
      coxme_allv_t8 )

anova(coxme_allv_t5, coxme_allv_t5minrh, coxme_allv_t5maxrh, coxme_allv_t8, 
      coxme_allv_t8min, coxme_allv_t8max)
#We do ANOVA of the ones preferred in the previous ANOVA, minT and GDD (lower AIC
# and BIC).

##PREFERRED ONES: MAXRH as preferred RH, MinT and GDD as preferred temperatures

#Model 3:~photoperiod + maxrh + mintemperature + (1 | location/method)
#Model 6: ~photoperiod + maxrh + daily_acc_gdd + (1 | location/method)

print(coxme_allv_t5maxrh)
exp(confint(coxme_allv_t5maxrh))

##AND WHAT ABOUT THE GDD?

print(coxme_allv_t8max)
exp(confint(coxme_allv_t8max))
```

**3. Model 4. (1|LOCATION) + (1|METHOD) + (1|LOCATION/METHOD)**

```{r}
coxme_t5_min<- coxme(Surv(total_lived, censored) ~ photoperiod + mintemperature +
                       minrh+
                    (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)
print(coxme_t5_min)

coxme_t5_max<- coxme(Surv(total_lived, censored) ~ photoperiod + mintemperature +
                       maxrh +
                    (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)
coxme_t5<- coxme(Surv(total_lived, censored) ~ photoperiod + mintemperature+ minrh
                 + maxrh + 
                    (1|location/method) + (1|location) + (1|method), 
                     data= new_df_gdd, refine.n = 500)
print(coxme_t5_max)
anova(coxme_t5,coxme_t5_min, coxme_t5_max) #looking the ANOVA, the
#best is the third, including only maxrh


coxme_t4<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh +  mwi + (1|location/method) + (1|location) 
                 + (1|method), data= new_df_gdd, 
                    refine.n = 500)
coxme_t4min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                        mwi + (1|location/method) + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)
coxme_t4max<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                      maxrh +  mwi + (1|location/method) + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

anova(coxme_t4, coxme_t4min, coxme_t4max)

coxme_t6<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + mintemperature +
                      mwi + (1|location/method) + (1|location) + (1|method),
                 data= new_df_gdd, 
                    refine.n = 500)
coxme_t6min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                       mintemperature +
                      mwi + (1|location/method) + (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)
coxme_t6max<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                      maxrh + mintemperature +
                      mwi + (1|location/method) + (1|location) + (1|method),
                    data= new_df_gdd, 
                    refine.n = 500)

anova(coxme_t6, coxme_t6min, coxme_t6max)


coxme_t7<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + daily_acc_gdd +
                      mintemperature + (1|location/method) + (1|location) + (1|method),
                 data= new_df_gdd, 
                    refine.n = 500)
coxme_t7min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                       daily_acc_gdd +
                      mintemperature + (1|location/method) + (1|location) + 
                        (1|method), data= new_df_gdd, 
                    refine.n = 500)
coxme_t7max<- coxme(Surv(total_lived, censored) ~ photoperiod  +
                      maxrh + daily_acc_gdd +
                      mintemperature + (1|location/method) + (1|location) +
                        (1|method), data= new_df_gdd, 
                    refine.n = 500)
anova(coxme_t7, coxme_t7min, coxme_t7max)


coxme_t8<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      maxrh + daily_acc_gdd + (1|location/method) + 
                    (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

coxme_t8min<- coxme(Surv(total_lived, censored) ~ photoperiod + minrh  +
                      daily_acc_gdd + (1|location/method) + (1|location) + 
                      (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

coxme_t8max<- coxme(Surv(total_lived, censored) ~ photoperiod + 
                      maxrh + daily_acc_gdd + (1|location/method) + 
                      (1|location) + (1|method), 
                    data= new_df_gdd, 
                    refine.n = 500)

anova(coxme_t8, coxme_t8min, coxme_t8max)
#All temperatures  + maxrh
print(coxme_t4max)
print(coxme_t5_max)
print(coxme_t6max)
print(coxme_t7max) #collinear
print(coxme_t8max)
anova(coxme_t4max,coxme_t5_max,coxme_t6max,
      coxme_t7max,coxme_t8max)

#All temperatures + minrh
print(coxme_t4min)
print(coxme_t5_min)
print(coxme_t6min)
print(coxme_t7min) #collinear
print(coxme_t8min)
anova(coxme_t4min,coxme_t5_min,coxme_t6min, coxme_t8min)

#All temperatures + all RH
print(coxme_t4)
print(coxme_t5)
print(coxme_t6)
print(coxme_t7) #collinear
print(coxme_t8)
anova(coxme_t4,coxme_t5,coxme_t6,
      coxme_t8 )

anova(coxme_t5_min, coxme_t5_max, coxme_t5, coxme_t8min, 
      coxme_t8max, coxme_t8)
#We do ANOVA of the ones preferred in the previous ANOVA, minT and GDD (lower AIC
# and BIC).

##PREFERRED ONES: MAXRH as preferred RH, MinT and GDD as preferred temperatures

#Model 2:~photoperiod + mintemperature + maxrh + (1 | location/method) +(1 | location) + (1 | method)
#Model 6: ~photoperiod + minrh + maxrh + daily_acc_gdd + (1 | location/method) +(1 | location) + (1 | method)

print(coxme_t5_max)
exp(confint(coxme_t5_max))

##AND WHAT ABOUT THE GDD?

print(coxme_t8)
exp(confint(coxme_t8))
```

#Finally... which one?

```{r}
anova(cox_allv5, coxme_t8, coxme_t5_max, coxme_allv_t5maxrh, coxme_allv_t8max, 
      coxme_allv5_maxrh, coxme_allv8max) #the 3 first are not the best

```

```{r}
cox.zph(coxme_t8, transform="km", global=TRUE)
ggcoxzph(cox.zph(coxme_t8))
```

```{r}
cox.zph(coxme_t5_max, transform="km", global=TRUE)
ggcoxzph(cox.zph(coxme_t5_max))
```

```{r}
cox.zph(coxme_t8max, transform="km", global=TRUE)
ggcoxzph(cox.zph(coxme_t8max))
```

```{r}
library(devtools)
#devtools::install_github('junkka/ehahelper')
# Create dummy dataset
spline_values <- tibble(photoperiod = seq(1, 19, by = 0.1))

newdata <- new_df_gdd %>% 
    head(n = 1) %>%
    select(total_lived, censored, daily_acc_gdd, maxrh, minrh, location, method, photoperiod) %>% 
    slice(rep(1:n(), each = nrow(spline_values)))
newdata <- newdata %>% mutate(photoperiod = spline_values$photoperiod)

# Ehahelper predict_coxme has difficulty with splines in a new dataset. 
# To get around this, append the new dataset to the old one, apply the predict_coxme function, then subset the predicted values of interest
dat <- bind_rows(new_df_gdd, newdata, id= NULL)

pred <- ehahelper::predict_coxme(coxme_t8, newdata = dat, se.fit = TRUE, type = "risk", strata_ref = FALSE)
          
dat <- dat %>% add_column(rr = pred$fit[,1], se.fit = pred$se.fit[,1])

# Subset values of interest
dat <- dat %>% tail(nrow(newdata))
          
dat <- dat %>% mutate(
    low = exp(log(rr) - 1.96 * se.fit), 
    high = exp(log(rr) + 1.96 * se.fit))
          
ggplot(dat, aes(photoperiod)) +
  geom_line(aes(y = rr)) +
  geom_ribbon(aes(ymin = low, ymax = high), alpha = 0.1, linetype = 0)

```
